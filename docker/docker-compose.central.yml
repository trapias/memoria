# Memoria Dual-Database Architecture + Web UI
# Central docker-compose for Qdrant (vectors) + PostgreSQL (relational) + Web UI
#
# ═══════════════════════════════════════════════════════════════════════════════
# ARCHITECTURE OVERVIEW
# ═══════════════════════════════════════════════════════════════════════════════
#
#   ┌─────────────────┐     ┌─────────────────┐
#   │  Claude Code 1  │     │  Claude Code 2  │     (different devices)
#   │       │         │     │       │         │
#   │  ┌────▼────┐    │     │  ┌────▼────┐    │
#   │  │ Memoria │    │     │  │ Memoria │    │     ← LOCAL PROCESSES (stdio)
#   │  │ (local) │    │     │  │ (local) │    │       Isolated WorkingMemory
#   │  └────┬────┘    │     │  └────┬────┘    │
#   └───────┼─────────┘     └───────┼─────────┘
#           │                       │
#           └───────────┬───────────┘
#                       │
#   ┌───────────────────▼───────────────────────────────────────┐
#   │                    Central Docker                          │
#   │                                                            │
#   │  ┌─────────────┐  ┌─────────────┐  ┌───────────────────┐  │
#   │  │   Qdrant    │  │ PostgreSQL  │  │    Web UI + API   │  │
#   │  │   :6333     │  │   :5433     │  │  :3000 (UI)       │  │
#   │  │  (vectors)  │  │ (relations) │  │  :8765 (API)      │  │
#   │  └─────────────┘  └─────────────┘  └───────────────────┘  │
#   │                                                            │
#   └────────────────────────────────────────────────────────────┘
#                       │
#           ┌───────────▼───────────┐
#           │  Browser (any device) │  → http://localhost:3000
#           │  - Graph Explorer     │
#           │  - Memory Browser     │
#           │  - Dashboard          │
#           └───────────────────────┘
#
# This architecture provides:
#   - Isolated WorkingMemory for each Claude session (stdio)
#   - Shared persistent storage (Qdrant + PostgreSQL)
#   - Web UI accessible from any browser
#   - REST API for custom integrations
#
# ═══════════════════════════════════════════════════════════════════════════════
#
# Usage:
#   cd docker && ./start.sh central    # Start all services
#   cd docker && ./start.sh stop       # Stop all services
#
# Or manually:
#   cd docker && docker-compose -f docker-compose.central.yml up -d
#
# Environment variables (set in .env file or export):
#   POSTGRES_PASSWORD - Database password (default: memoria_dev)
#   EMBEDDING_MODEL   - Ollama model for embeddings (default: nomic-embed-text)
#
# Services:
#   - qdrant:      Vector database on :6333/:6334
#   - postgres:    Relational database on :5433 (external), :5432 (internal)
#   - memoria-ui:  Web UI on :3000, REST API on :8765
#
# Networks:
#   - All services on 'memoria-network' for inter-service communication

name: memoria

services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: memoria-qdrant

    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC

    volumes:
      - qdrant_data:/qdrant/storage

    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
      # Optional: API security
      # - QDRANT__API_KEY=${QDRANT_API_KEY}

    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/6333'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    restart: unless-stopped
    networks:
      - memoria-network

    labels:
      description: "Qdrant vector database"
      component: "storage"

  postgres:
    image: postgres:16-alpine
    container_name: memoria-postgres

    ports:
      - "5433:5432"  # Use 5433 externally to avoid conflicts with existing postgres

    environment:
      POSTGRES_USER: memoria
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-memoria_dev}
      POSTGRES_DB: memoria
      POSTGRES_INITDB_ARGS: "-c shared_buffers=256MB -c max_connections=100"

    volumes:
      - memoria-postgres-data:/var/lib/postgresql/data
      # Initialize database with schema on first run
      - ./init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U memoria -d memoria"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    restart: unless-stopped
    networks:
      - memoria-network

    labels:
      description: "PostgreSQL relational database"
      component: "storage"

  # ═══════════════════════════════════════════════════════════════════════════════
  # WEB UI + REST API
  # ═══════════════════════════════════════════════════════════════════════════════
  #
  # The Web UI provides:
  #   - Dashboard with memory stats
  #   - Knowledge Graph Explorer with interactive visualization
  #   - Memory browser with semantic search
  #   - Settings and system info
  #
  # The REST API (port 8765) provides:
  #   - Full CRUD for memories
  #   - Graph operations (relations, traversal, suggestions)
  #   - Stats and health endpoints
  #
  memoria-ui:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ui
    container_name: memoria-ui

    ports:
      - "3000:3000"   # Next.js Web UI
      - "8765:8765"   # REST API

    environment:
      # Qdrant connection (internal Docker network)
      - MEMORIA_QDRANT_HOST=qdrant
      - MEMORIA_QDRANT_PORT=6333
      # PostgreSQL connection (internal Docker network)
      - MEMORIA_DATABASE_URL=postgresql://memoria:${POSTGRES_PASSWORD:-memoria_dev}@postgres:5432/memoria
      # Ollama on host for embeddings
      - MEMORIA_OLLAMA_HOST=http://host.docker.internal:11434
      - MEMORIA_EMBEDDING_MODEL=${EMBEDDING_MODEL:-nomic-embed-text}
      # API settings
      - API_PORT=8765
      - CORS_ORIGINS=http://localhost:3000,http://127.0.0.1:3000
      # Next.js
      - NEXT_PUBLIC_API_URL=http://localhost:8765

    depends_on:
      qdrant:
        condition: service_healthy
      postgres:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    restart: unless-stopped
    networks:
      - memoria-network

    extra_hosts:
      - "host.docker.internal:host-gateway"

    labels:
      description: "Memoria Web UI + REST API"
      component: "ui"

volumes:
  qdrant_data:
    driver: local
  memoria-postgres-data:
    driver: local
  # memoria_cache:
  #   driver: local

networks:
  memoria-network:
    external: true
    name: memoria-network
