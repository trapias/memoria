# Memoria Dual-Database Architecture
# Central docker-compose for Qdrant (vectors) + PostgreSQL (relational)
#
# ═══════════════════════════════════════════════════════════════════════════════
# RECOMMENDED PRODUCTION ARCHITECTURE
# ═══════════════════════════════════════════════════════════════════════════════
#
# This file configures the SHARED DATABASES (Qdrant + PostgreSQL).
# Claude Code clients should run Memoria as a LOCAL PROCESS (stdio),
# NOT as a shared HTTP server.
#
#   ┌─────────────────┐     ┌─────────────────┐
#   │  Claude Code 1  │     │  Claude Code 2  │     (different devices)
#   │       │         │     │       │         │
#   │  ┌────▼────┐    │     │  ┌────▼────┐    │
#   │  │ Memoria │    │     │  │ Memoria │    │     ← SEPARATE PROCESSES (stdio)
#   │  │ (local) │    │     │  │ (local) │    │       Isolated WorkingMemory
#   │  └────┬────┘    │     │  └────┬────┘    │
#   └───────┼─────────┘     └───────┼─────────┘
#           │                       │
#           └───────────┬───────────┘
#                       │
#           ┌───────────▼───────────┐
#           │   Central Docker      │
#           │  ┌─────┐  ┌────────┐  │
#           │  │Qdrant│  │PostgreSQL│ │  ← THIS FILE
#           │  └─────┘  └────────┘  │
#           └───────────────────────┘
#
# This architecture ensures:
#   - Isolated WorkingMemory for each Claude session
#   - No risk of context confusion between sessions/users
#   - Shared persistent storage for long-term memories
#
# ═══════════════════════════════════════════════════════════════════════════════
#
# Usage:
#   cd docker && docker-compose -f docker-compose.central.yml up -d
#
# Environment variables:
#   POSTGRES_PASSWORD - Database password (default: memoria_dev)
#   QDRANT_API_KEY - Qdrant API key (optional, for security)
#
# Services:
#   - qdrant: Vector database on :6333/:6334
#   - postgres: Relational database on :5432
#
# Networks:
#   - All services on 'memoria' network for inter-service communication

name: memoria

services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: memoria-qdrant

    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC

    volumes:
      - qdrant_data:/qdrant/storage

    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
      # Optional: API security
      # - QDRANT__API_KEY=${QDRANT_API_KEY}

    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:6333/health | grep -q 'ok'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    restart: unless-stopped
    networks:
      - memoria-network

    labels:
      description: "Qdrant vector database"
      component: "storage"

  postgres:
    image: postgres:16-alpine
    container_name: memoria-postgres

    ports:
      - "5433:5432"  # Use 5433 externally to avoid conflicts with existing postgres

    environment:
      POSTGRES_USER: memoria
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-memoria_dev}
      POSTGRES_DB: memoria
      POSTGRES_INITDB_ARGS: "-c shared_buffers=256MB -c max_connections=100"

    volumes:
      - memoria-postgres-data:/var/lib/postgresql/data
      # Initialize database with schema on first run
      - ./init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U memoria -d memoria"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    restart: unless-stopped
    networks:
      - memoria-network

    labels:
      description: "PostgreSQL relational database"
      component: "storage"

  # ═══════════════════════════════════════════════════════════════════════════════
  # WEB UI + REST API
  # ═══════════════════════════════════════════════════════════════════════════════
  #
  # The Web UI provides:
  #   - Dashboard with memory stats
  #   - Knowledge Graph Explorer with interactive visualization
  #   - Memory browser with semantic search
  #   - Settings and system info
  #
  # The REST API (port 8765) provides:
  #   - Full CRUD for memories
  #   - Graph operations (relations, traversal, suggestions)
  #   - Stats and health endpoints
  #
  memoria-ui:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ui
    container_name: memoria-ui

    ports:
      - "3000:3000"   # Next.js Web UI
      - "8765:8765"   # REST API

    environment:
      # Qdrant connection (internal Docker network)
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      # PostgreSQL connection (internal Docker network)
      - DATABASE_URL=postgresql://memoria:${POSTGRES_PASSWORD:-memoria_dev}@postgres:5432/memoria
      # Ollama on host for embeddings
      - OLLAMA_HOST=http://host.docker.internal:11434
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-nomic-embed-text}
      # API settings
      - API_PORT=8765
      - CORS_ORIGINS=http://localhost:3000,http://127.0.0.1:3000
      # Next.js
      - NEXT_PUBLIC_API_URL=http://localhost:8765

    depends_on:
      qdrant:
        condition: service_healthy
      postgres:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    restart: unless-stopped
    networks:
      - memoria-network

    extra_hosts:
      - "host.docker.internal:host-gateway"

    labels:
      description: "Memoria Web UI + REST API"
      component: "ui"

volumes:
  qdrant_data:
    driver: local
  memoria-postgres-data:
    driver: local
  # memoria_cache:
  #   driver: local

networks:
  memoria-network:
    external: true
    name: memoria-network
